import _mapKeys from "lodash/mapKeys";
import _map from "lodash/map";
import React, { useMemo, useCallback } from 'react';
import { FlatList } from 'react-native';
import { useSharedValue } from 'react-native-reanimated';
import { GestureHandlerRootView } from 'react-native-gesture-handler';
import SortableListContext from "./SortableListContext";
import SortableListItem from "./SortableListItem";
import { useDidUpdate } from "../../hooks";

function generateItemsOrder(data) {
  return _map(data, item => item.id);
}

const SortableList = props => {
  const {
    data,
    onOrderChange,
    enableHaptic,
    ...others
  } = props;
  const itemsOrder = useSharedValue(generateItemsOrder(data));
  const itemHeight = useSharedValue(52);
  useDidUpdate(() => {
    itemsOrder.value = generateItemsOrder(data);
  }, [data]);
  const onChange = useCallback(() => {
    const newData = [];

    const dataByIds = _mapKeys(data, 'id');

    if (data?.length) {
      itemsOrder.value.forEach(itemId => {
        newData.push(dataByIds[itemId]);
      });
    }

    onOrderChange?.(newData);
  }, [onOrderChange, data]);
  const onItemLayout = useCallback(event => {
    // Round height for Android
    const newHeight = Math.round(event.nativeEvent.layout.height);
    itemHeight.value = newHeight;
  }, []);
  const context = useMemo(() => {
    return {
      data,
      itemsOrder,
      onChange,
      itemHeight,
      onItemLayout,
      enableHaptic
    };
  }, [data]);
  return <GestureHandlerRootView>
      <SortableListContext.Provider value={context}>
        <FlatList {...others} data={data} CellRendererComponent={SortableListItem} removeClippedSubviews={false} // Workaround for crashing on Android (ArrayIndexOutOfBoundsException in ViewGroupDrawingOrderHelper.getChildDrawingOrder)
      />
      </SortableListContext.Provider>
    </GestureHandlerRootView>;
};

export default SortableList;